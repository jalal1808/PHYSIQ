<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Physiq AI</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-slate-950 text-white h-screen">

<script>
const API_BASE = "http://localhost:8000";
let isSignup = false;

window.onload = () => {
  if (localStorage.getItem("access_token")) showApp();
};

function toggleAuthMode() {
  isSignup = !isSignup;
  document.getElementById("signup-fields").classList.toggle("hidden", !isSignup);
  document.getElementById("auth-title").innerText = isSignup ? "Create Account" : "Login";
}

async function authSubmit(e) {
  e.preventDefault();

  const email = emailInput.value;
  const password = passwordInput.value;

  try {
    if (isSignup) {
      const res = await fetch(`${API_BASE}/auth/signup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          password,
          weight_kg: Number(weightInput.value) || null,
          height_cm: Number(heightInput.value) || null,
        }),
      });

      if (!res.ok) throw await res.json();
      alert("Signup successful. Please login.");
      toggleAuthMode();
      return;
    }

    const res = await fetch(`${API_BASE}/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    const data = await res.json();
    if (!res.ok) throw data;

    localStorage.setItem("access_token", data.access_token);
    showApp();

  } catch (err) {
    alert(err.detail || "Authentication failed");
  }
}

function showApp() {
  authSection.classList.add("hidden");
  appSection.classList.remove("hidden");
}

async function logout() {
  await fetch(`${API_BASE}/auth/logout`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${localStorage.getItem("access_token")}`,
    },
  });
  localStorage.clear();
  location.reload();
}

async function sendMessage(e) {
  e.preventDefault();
  const msg = chatInput.value.trim();
  if (!msg) return;

  append("You", msg);
  chatInput.value = "";

  try {
    const res = await fetch(`${API_BASE}/chat`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
      },
      body: JSON.stringify({ message: msg }),
    });

    const data = await res.json();
    if (!res.ok) throw data;
    append("AI", data.response);

  } catch {
    append("AI", "Error contacting AI");
  }
}

async function updateProfile() {
  try {
    const res = await fetch(`${API_BASE}/user/profile`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
      },
      body: JSON.stringify({
        weight_kg: Number(profileWeight.value),
        height_cm: Number(profileHeight.value),
      }),
    });

    if (!res.ok) throw await res.json();
    alert("Profile updated");

  } catch (e) {
    alert(e.detail || "Update failed");
  }
}

function append(sender, text) {
  const div = document.createElement("div");
  div.className = "mb-3";
  div.innerHTML = `<b>${sender}:</b> ${text}`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}
</script>

<!-- AUTH -->
<div id="authSection" class="flex items-center justify-center h-full">
  <form onsubmit="authSubmit(event)" class="bg-slate-900 p-6 rounded-xl w-96">
    <h2 id="auth-title" class="text-xl mb-4">Login</h2>

    <input id="emailInput" type="email" placeholder="Email"
      class="w-full mb-3 p-2 rounded bg-slate-800" required />

    <input id="passwordInput" type="password" placeholder="Password"
      class="w-full mb-3 p-2 rounded bg-slate-800" required />

    <div id="signup-fields" class="hidden">
      <input id="weightInput" type="number" placeholder="Weight (kg)"
        class="w-full mb-2 p-2 rounded bg-slate-800" />
      <input id="heightInput" type="number" placeholder="Height (cm)"
        class="w-full mb-3 p-2 rounded bg-slate-800" />
    </div>

    <button class="bg-indigo-600 w-full p-2 rounded">Submit</button>

    <p class="mt-3 text-sm cursor-pointer text-indigo-400"
      onclick="toggleAuthMode()">Toggle Signup / Login</p>
  </form>
</div>

<!-- APP -->
<div id="appSection" class="hidden h-full flex">
  <div class="w-1/4 bg-slate-900 p-4">
    <button onclick="logout()" class="bg-red-600 w-full p-2 rounded">Logout</button>
    <hr class="my-4">
    <input id="profileWeight" placeholder="Weight"
      class="w-full mb-2 p-2 bg-slate-800 rounded">
    <input id="profileHeight" placeholder="Height"
      class="w-full mb-2 p-2 bg-slate-800 rounded">
    <button onclick="updateProfile()" class="bg-green-600 w-full p-2 rounded">
      Update Profile
    </button>
  </div>

  <div class="flex-1 p-4">
    <div id="chatBox" class="h-[80vh] overflow-y-auto mb-4"></div>
    <form onsubmit="sendMessage(event)">
      <input id="chatInput" placeholder="Ask your AI coach..."
        class="w-full p-3 bg-slate-800 rounded" />
    </form>
  </div>
</div>

<script>lucide.createIcons();</script>
</body>
</html>
